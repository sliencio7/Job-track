<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Track - 求职追踪</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 D3.js CDN 用于图表绘制 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- 引入 Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom CSS to ensure Inter font, fallback to generic sans-serif */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8;
            /* Light background color */
        }

        /* Hide scrollbar but allow scrolling */
        body::-webkit-scrollbar {
            display: none;
        }

        body {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* Modal backdrop for overlay effect */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Table hover effect */
        .hover-row:hover {
            background-color: #f0f0f0;
        }

        /* Simple fade-in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }

        /* Force date input font to be consistent */
        input[type="date"] {
            font-family: 'Inter', sans-serif;
        }

        /* Hide elements visually but keep for screen readers */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>

<body class="flex min-h-screen">
    <!-- Main application container -->
    <div class="flex flex-col md:flex-row w-full bg-gray-50">
        <!-- Left Sidebar -->
        <aside class="w-full md:w-64 bg-white p-6 md:p-8 shadow-lg md:shadow-xl flex-shrink-0 rounded-r-xl">
            <div class="flex items-center justify-between mb-8 md:mb-10">
                <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">Job Track</h1>
                <!-- Menu toggle for mobile -->
                <button id="menu-toggle" class="md:hidden text-gray-600 focus:outline-none">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>

            <!-- Navigation menu -->
            <nav id="main-nav" class="hidden md:block">
                <ul class="space-y-4">
                    <li>
                        <a href="#"
                            class="flex items-center p-3 text-lg font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <i class="fas fa-book-open mr-3"></i>使用教程
                        </a>
                    </li>
                    <li>
                        <a href="#"
                            class="flex items-center p-3 text-lg font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <i class="fas fa-headset mr-3"></i>联系我们
                        </a>
                    </li>
                    <li>
                        <a href="#"
                            class="flex items-center p-3 text-lg font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <i class="fas fa-code mr-3"></i>开发建议
                        </a>
                    </li>
                </ul>
                <div class="mt-8 border-t border-gray-200 pt-8 space-y-4">
                    <!-- Placeholder for future mini-program integrations -->
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">未来集成</h3>
                    <ul>
                        <li>
                            <a href="#"
                                class="flex items-center p-3 text-md text-gray-600 hover:bg-green-50 hover:text-green-700 rounded-lg transition duration-200">
                                <i class="fas fa-hand-holding-heart mr-3"></i>彩虹卡
                            </a>
                        </li>
                        <li>
                            <a href="#"
                                class="flex items-center p-3 text-md text-gray-600 hover:bg-purple-50 hover:text-purple-700 rounded-lg transition duration-200">
                                <i class="fas fa-robot mr-3"></i>AI 模拟面试
                            </a>
                        </li>
                        <li>
                            <a href="#"
                                class="flex items-center p-3 text-md text-gray-600 hover:bg-yellow-50 hover:text-yellow-700 rounded-lg transition duration-200">
                                <i class="fas fa-balance-scale mr-3"></i>心态调节
                            </a>
                        </li>
                        <li>
                            <a href="#"
                                class="flex items-center p-3 text-md text-gray-600 hover:bg-red-50 hover:text-red-700 rounded-lg transition duration-200">
                                <i class="fas fa-external-link-alt mr-3"></i>Offershow
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Right main content area -->
        <main class="flex-1 p-6 md:p-10">
            <!-- Top user header -->
            <header class="flex items-center justify-between mb-8 pb-4 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">概览</h2>
                <div class="flex items-center space-x-4">
                    <div class="flex flex-col text-right">
                        <span class="text-sm font-medium text-gray-700" id="user-id">ID: user_12345</span>
                        <span class="text-xs text-gray-500" id="registration-time">注册时间: 2023-01-01</span>
                    </div>
                    <img src="https://placehold.co/48x48/999999/FFFFFF/png?text=AV" alt="用户头像"
                        class="w-12 h-12 rounded-full border-2 border-blue-400 shadow-md">
                </div>
            </header>

            <!-- Statistics overview section -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <!-- Job parsing -->
                <div
                    class="bg-white p-6 rounded-xl shadow-md border border-gray-200 col-span-1 md:col-span-1 animate-fadeIn">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">岗位解析</h3>
                    <div class="flex flex-col space-y-4">
                        <textarea id="job-link-input"
                            placeholder="粘贴岗位链接或文字到此，例如：https://careers.google.com/jobs/results/12345/ 或 岗位名称，公司，要求..."
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 h-24 resize-y text-gray-700"></textarea>
                        <button id="parse-job-btn"
                            class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            解析并添加岗位
                        </button>
                    </div>
                </div>

                <!-- Interview and Offer statistics -->
                <div
                    class="bg-white p-6 rounded-xl shadow-md border border-gray-200 col-span-1 md:col-span-1 flex flex-col justify-between animate-fadeIn">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">面试与 Offer</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div id="interview-count-box"
                            class="bg-yellow-50 p-4 rounded-lg flex flex-col items-center justify-center border border-yellow-200 cursor-pointer hover:bg-yellow-100 transition duration-200">
                            <span class="text-4xl font-bold text-yellow-700" id="interview-count">0</span>
                            <span class="text-lg text-yellow-600 mt-2">面试</span>
                        </div>
                        <div id="offer-count-box"
                            class="bg-green-50 p-4 rounded-lg flex flex-col items-center justify-center border border-green-200 cursor-pointer hover:bg-green-100 transition duration-200">
                            <span class="text-4xl font-bold text-green-700" id="offer-count">0</span>
                            <span class="text-lg text-green-600 mt-2">Offer</span>
                        </div>
                    </div>
                </div>

                <!-- Submission overview (chart) -->
                <div
                    class="bg-white p-6 rounded-xl shadow-md border border-gray-200 col-span-1 md:col-span-1 flex flex-col animate-fadeIn">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">投递情况一览</h3>
                    <div class="flex justify-around mb-4">
                        <button id="toggle-weekly"
                            class="px-4 py-2 rounded-lg font-medium text-sm transition duration-200 bg-blue-100 text-blue-700 hover:bg-blue-200">近七日</button>
                        <button id="toggle-monthly"
                            class="px-4 py-2 rounded-lg font-medium text-sm transition duration-200 text-gray-600 hover:bg-gray-100">月度</button>
                    </div>
                    <!-- Monthly view selectors -->
                    <div id="monthly-selectors" class="flex space-x-4 mb-4 justify-center hidden">
                        <label for="year-select" class="sr-only">选择年份</label>
                        <select id="year-select"
                            class="px-4 py-2 rounded-md border border-gray-300 text-lg focus:ring-blue-500 focus:border-blue-500">
                        </select>

                        <label for="month-select" class="sr-only">选择月份</label>
                        <select id="month-select"
                            class="px-4 py-2 rounded-md border border-gray-300 text-lg focus:ring-blue-500 focus:border-blue-500">
                        </select>
                    </div>
                    <!-- D3.js Chart Container -->
                    <div id="submissions-chart-container" class="flex-1 w-full h-48 flex items-center justify-center">
                        <svg id="submissions-chart" class="w-full h-full"></svg>
                    </div>
                    <p id="no-chart-data-message" class="text-gray-500 mt-4 text-center hidden">当前月份没有投递记录。</p>
                </div>
            </section>

            <!-- Job list table -->
            <section class="bg-white p-6 rounded-xl shadow-md border border-gray-200 animate-fadeIn">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-700">岗位情况</h3>
                    <button id="add-new-job-btn"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-500 focus:ring-opacity-50">
                        <i class="fas fa-plus mr-2"></i>添加新岗位
                    </button>
                </div>

                <!-- Filter and sort area -->
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <input type="text" id="global-search-input" placeholder="全局搜索 (公司, 岗位, 关键词等)"
                        class="flex-1 min-w-[200px] p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-400 text-gray-700">

                    <select id="filter-status"
                        class="p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-400 text-gray-700">
                        <option value="">所有状态</option>
                        <option value="投递">投递</option>
                        <option value="测评">测评</option>
                        <option value="笔试">笔试</option>
                        <option value="一面">一面</option>
                        <option value="二面">二面</option>
                        <option value="终面">终面</option>
                        <option value="HR面">HR面</option>
                        <option value="OC">OC</option>
                        <option value="拒绝">拒绝</option>
                    </select>

                    <input type="date" id="filter-start-date"
                        class="p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-400 text-gray-700">
                    <span class="text-gray-500">至</span>
                    <input type="date" id="filter-end-date"
                        class="p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-400 text-gray-700">

                    <button id="reset-filters"
                        class="p-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition duration-200">
                        <i class="fas fa-times-circle mr-1"></i>重置筛选
                    </button>
                </div>

                <!-- Table container -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg cursor-pointer hover:bg-gray-100 transition duration-150 relative"
                                    data-sort-key="time">
                                    投递时间<span
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 sort-icon"><i
                                            class="fas fa-sort"></i></span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition duration-150 relative"
                                    data-sort-key="company">
                                    公司<span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 sort-icon"><i
                                            class="fas fa-sort"></i></span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition duration-150 relative"
                                    data-sort-key="position">
                                    岗位<span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 sort-icon"><i
                                            class="fas fa-sort"></i></span>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    关键词</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    行业</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition duration-150 relative"
                                    data-sort-key="status">
                                    状态<span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 sort-icon"><i
                                            class="fas fa-sort"></i></span>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    地点</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    备注</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg cursor-pointer hover:bg-gray-100 transition duration-150 relative"
                                    data-sort-key="level">
                                    等级分类<span
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 sort-icon"><i
                                            class="fas fa-sort"></i></span>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    操作</th>
                            </tr>
                        </thead>
                        <tbody id="job-entries-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Job records will be dynamically loaded here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="no-records-message" class="text-center text-gray-500 mt-4 hidden">暂无岗位记录。点击“添加新岗位”开始记录吧！</div>
            </section>
        </main>
    </div>

    <!-- Modal for adding/editing jobs -->
    <div id="job-modal"
        class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden modal-backdrop animate-fadeIn">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6">添加新岗位</h3>
            <form id="job-form" class="space-y-4">
                <div>
                    <label for="modal-time" class="block text-gray-700 text-sm font-medium mb-1">投递时间</label>
                    <input type="date" id="modal-time"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-transparent text-gray-700">
                </div>
                <div>
                    <label for="modal-company" class="block text-gray-700 text-sm font-medium mb-1">公司</label>
                    <input type="text" id="modal-company" placeholder="公司名称"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-transparent text-gray-700">
                </div>
                <div>
                    <label for="modal-position" class="block text-gray-700 text-sm font-medium mb-1">岗位</label>
                    <input type="text" id="modal-position" placeholder="岗位名称"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-transparent text-gray-700">
                </div>
                <div>
                    <label for="modal-keywords" class="block text-gray-700 text-sm font-medium mb-1">关键词</label>
                    <input type="text" id="modal-keywords" placeholder="例如：前端, Vue, React"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-transparent text-gray-700">
                </div>
                <div>
                    <label for="modal-industry" class="block text-gray-700 text-sm font-medium mb-1">行业</label>
                    <input type="text" id="modal-industry" placeholder="例如：互联网, 金融"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-transparent text-gray-700">
                </div>
                <div>
                    <label for="modal-status" class="block text-gray-700 text-sm font-medium mb-1">状态</label>
                    <select id="modal-status"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-transparent text-gray-700">
                        <option value="投递">投递</option>
                        <option value="测评">测评</option>
                        <option value="笔试">笔试</option>
                        <option value="一面">一面</option>
                        <option value="二面">二面</option>
                        <option value="终面">终面</option>
                        <option value="HR面">HR面</option>
                        <option value="OC">OC</option>
                        <option value="拒绝">拒绝</option>
                    </select>
                </div>
                <div>
                    <label for="modal-location" class="block text-gray-700 text-sm font-medium mb-1">地点</label>
                    <input type="text" id="modal-location" placeholder="例如：上海, 远程"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-transparent text-gray-700">
                </div>
                <div>
                    <label for="modal-notes" class="block text-gray-700 text-sm font-medium mb-1">备注</label>
                    <textarea id="modal-notes" placeholder="其他重要信息"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-transparent h-20 resize-y text-gray-700"></textarea>
                </div>
                <div>
                    <label for="modal-level" class="block text-gray-700 text-sm font-medium mb-1">等级分类</label>
                    <select id="modal-level"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-transparent text-gray-700">
                        <option value="低">低</option>
                        <option value="中">中</option>
                        <option value="高">高</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-modal-btn"
                        class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition duration-200">
                        取消
                    </button>
                    <button type="submit" id="save-job-btn"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Job Track Web App JavaScript Logic

        // --- DOM element references ---
        const menuToggle = document.getElementById('menu-toggle');
        const mainNav = document.getElementById('main-nav');
        const userIdSpan = document.getElementById('user-id');
        const registrationTimeSpan = document.getElementById('registration-time');
        const interviewCountSpan = document.getElementById('interview-count');
        const offerCountSpan = document.getElementById('offer-count');
        const parseJobInput = document.getElementById('job-link-input');
        const parseJobBtn = document.getElementById('parse-job-btn');
        const toggleWeeklyBtn = document.getElementById('toggle-weekly');
        const toggleMonthlyBtn = document.getElementById('toggle-monthly');
        const monthlySelectorsDiv = document.getElementById('monthly-selectors');
        const yearSelect = document.getElementById('year-select');
        const monthSelect = document.getElementById('month-select');
        const submissionsChartSvg = d3.select("#submissions-chart");
        const noChartDataMessage = document.getElementById('no-chart-data-message');
        const jobEntriesTbody = document.getElementById('job-entries-tbody');
        const noRecordsMessage = document.getElementById('no-records-message');
        const addNewJobBtn = document.getElementById('add-new-job-btn');

        // Filter & Sort elements
        const globalSearchInput = document.getElementById('global-search-input');
        const filterStatusSelect = document.getElementById('filter-status');
        const filterStartDateInput = document.getElementById('filter-start-date');
        const filterEndDateInput = document.getElementById('filter-end-date');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const tableHeaders = document.querySelectorAll('th[data-sort-key]'); // Clickable table headers for sorting

        // Modal elements
        const jobModal = document.getElementById('job-modal');
        const modalTitle = document.getElementById('modal-title');
        const jobForm = document.getElementById('job-form');
        const modalTimeInput = document.getElementById('modal-time');
        const modalCompanyInput = document.getElementById('modal-company');
        const modalPositionInput = document.getElementById('modal-position');
        const modalKeywordsInput = document.getElementById('modal-keywords');
        const modalIndustryInput = document.getElementById('modal-industry');
        const modalStatusSelect = document.getElementById('modal-status');
        const modalLocationInput = document.getElementById('modal-location');
        const modalNotesInput = document.getElementById('modal-notes');
        const modalLevelSelect = document.getElementById('modal-level');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const saveJobBtn = document.getElementById('save-job-btn');

        // --- Application State ---
        let jobRecords = []; // Stores all job records
        let currentEditingJobId = null; // ID of the job currently being edited
        let currentChartPeriod = 'weekly'; // Current chart view: 'weekly' or 'monthly'
        let currentSortColumn = 'time'; // Current column by which table is sorted
        let currentSortOrder = 'desc'; // Current sort order: 'asc' (ascending) or 'desc' (descending)

        // --- Initialization on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize user info (ID persisted in localStorage)
            userIdSpan.textContent = `ID: ${generateUserId()}`;
            registrationTimeSpan.textContent = `注册时间: ${formatDate(new Date())}`;

            populateYearMonthSelectors(); // Populate year/month dropdowns
            loadJobRecords(); // Load records from localStorage
            updateOverviewStats(); // Update overview statistics
            renderJobTable(); // Render the job table
            renderSubmissionsChart(); // Render the chart

            // Initialize date inputs
            const today = new Date();
            modalTimeInput.value = formatDate(today); // Default today for modal
            const oneMonthAgo = new Date(today);
            oneMonthAgo.setMonth(today.getMonth() - 1);
            filterStartDateInput.value = formatDate(oneMonthAgo); // Default filter start date
            filterEndDateInput.value = formatDate(today); // Default filter end date

            updateSortIcons(); // Set initial sort icons
        });

        // --- Helper Functions ---

        /**
         * Generates a simple user ID and persists it in localStorage.
         * @returns {string} The user ID.
         */
        function generateUserId() {
            let userId = localStorage.getItem('jobTrackUserId');
            if (!userId) {
                userId = `user_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('jobTrackUserId', userId);
            }
            return userId;
        }

        /**
         * Formats a Date object to YYYY-MM-DD string.
         * @param {Date} date The date object to format.
         * @returns {string} Formatted date string.
         */
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Loads job records from localStorage.
         */
        function loadJobRecords() {
            try {
                const storedRecords = localStorage.getItem('jobTrackRecords');
                if (storedRecords) {
                    jobRecords = JSON.parse(storedRecords);
                    // Convert date strings back to Date objects
                    jobRecords.forEach(record => {
                        record.time = new Date(record.time);
                    });
                }
            } catch (e) {
                console.error("Failed to load records from localStorage:", e);
                jobRecords = [];
            }
        }

        /**
         * Saves job records to localStorage.
         */
        function saveJobRecords() {
            try {
                // Convert Date objects to YYYY-MM-DD strings for storage
                const recordsToStore = jobRecords.map(record => ({
                    ...record,
                    time: record.time.toISOString().slice(0, 10)
                }));
                localStorage.setItem('jobTrackRecords', JSON.stringify(recordsToStore));
            } catch (e) {
                console.error("Failed to save records to localStorage:", e);
            }
        }

        /**
         * Updates the interview and offer count in the overview section.
         */
        function updateOverviewStats() {
            // Interviews include: 一面, 二面, 终面, HR面
            const interviews = jobRecords.filter(job =>
                ['一面', '二面', '终面', 'HR面'].includes(job.status)
            ).length;
            // Offers only include: OC
            const offers = jobRecords.filter(job => job.status === 'OC').length;
            interviewCountSpan.textContent = interviews;
            offerCountSpan.textContent = offers;
        }

        /**
         * Renders the job records table based on current filters and sort order.
         */
        function renderJobTable() {
            const tbody = jobEntriesTbody;
            tbody.innerHTML = ''; // Clear existing content

            let displayedRecords = [...jobRecords]; // Work on a copy

            // --- Apply Filters ---
            const globalSearchQuery = globalSearchInput.value.toLowerCase();
            const statusFilter = filterStatusSelect.value;
            const startDate = filterStartDateInput.value ? new Date(filterStartDateInput.value) : null;
            const endDate = filterEndDateInput.value ? new Date(filterEndDateInput.value) : null;

            if (globalSearchQuery) {
                displayedRecords = displayedRecords.filter(job =>
                    job.company.toLowerCase().includes(globalSearchQuery) ||
                    job.position.toLowerCase().includes(globalSearchQuery) ||
                    job.keywords.toLowerCase().includes(globalSearchQuery) ||
                    job.industry.toLowerCase().includes(globalSearchQuery) ||
                    job.location.toLowerCase().includes(globalSearchQuery) ||
                    (job.notes && job.notes.toLowerCase().includes(globalSearchQuery))
                );
            }
            if (statusFilter) {
                displayedRecords = displayedRecords.filter(job => job.status === statusFilter);
            }
            if (startDate || endDate) {
                displayedRecords = displayedRecords.filter(job => {
                    const jobTime = new Date(job.time);
                    jobTime.setHours(0, 0, 0, 0); // Clear time for date-only comparison
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    if (start) start.setHours(0, 0, 0, 0);
                    if (end) end.setHours(23, 59, 59, 999); // End date includes the whole day

                    return (!start || jobTime >= start) && (!end || jobTime <= end);
                });
            }

            // --- Apply Sorting ---
            displayedRecords.sort((a, b) => {
                let valA, valB;
                switch (currentSortColumn) {
                    case 'time':
                        valA = a.time.getTime();
                        valB = b.time.getTime();
                        break;
                    case 'company':
                    case 'position':
                    case 'status':
                        valA = a[currentSortColumn].toLowerCase();
                        valB = b[currentSortColumn].toLowerCase();
                        break;
                    case 'level':
                        const levelMap = { '低': 1, '中': 2, '高': 3 }; // Map levels to numbers for sorting
                        valA = levelMap[a.level];
                        valB = levelMap[b.level];
                        break;
                    default:
                        valA = a.time.getTime();
                        valB = b.time.getTime();
                }

                if (typeof valA === 'string' && typeof valB === 'string') {
                    return currentSortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return currentSortOrder === 'asc' ? (valA - valB) : (valB - valA);
            });

            // --- Render Table Rows ---
            if (displayedRecords.length === 0) {
                noRecordsMessage.classList.remove('hidden');
                tbody.classList.add('hidden');
            } else {
                noRecordsMessage.classList.add('hidden');
                tbody.classList.remove('hidden');
                displayedRecords.forEach(job => {
                    const row = tbody.insertRow();
                    row.classList.add('hover-row', 'transition-all', 'duration-150');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatDate(job.time)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${job.company}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${job.position}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${job.keywords}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${job.industry}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(job.status)}">
                                ${job.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${job.location}</td>
                        <td class="px-6 py-4 text-sm text-gray-700 whitespace-pre-wrap">${job.notes || '无'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            <span class="${getLevelBadgeClass(job.level)}">${job.level}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${job.id}" class="edit-btn text-blue-600 hover:text-blue-900 mr-3"><i class="fas fa-edit"></i></button>
                            <button data-id="${job.id}" class="delete-btn text-red-600 hover:text-red-900"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                });
                addJobTableEventListeners(); // Attach event listeners to new buttons
            }
            updateSortIcons(); // Update sort indicators on table headers
        }

        /**
         * Returns Tailwind CSS classes for status badges.
         * @param {string} status The job status.
         * @returns {string} Tailwind CSS classes.
         */
        function getStatusBadgeClass(status) {
            switch (status) {
                case '投递': return 'bg-blue-100 text-blue-800';
                case '测评': return 'bg-purple-100 text-purple-800';
                case '笔试': return 'bg-cyan-100 text-cyan-800';
                case '一面': return 'bg-yellow-100 text-yellow-800';
                case '二面': return 'bg-orange-100 text-orange-800';
                case '终面': return 'bg-red-100 text-red-800';
                case 'HR面': return 'bg-pink-100 text-pink-800';
                case 'OC': return 'bg-green-100 text-green-800';
                case '拒绝': return 'bg-gray-400 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        /**
         * Returns Tailwind CSS classes for level badges.
         * @param {string} level The job level.
         * @returns {string} Tailwind CSS classes.
         */
        function getLevelBadgeClass(level) {
            switch (level) {
                case '低': return 'bg-gray-200 text-gray-800 px-2 py-1 rounded-md text-xs font-semibold';
                case '中': return 'bg-purple-100 text-purple-800 px-2 py-1 rounded-md text-xs font-semibold';
                case '高': return 'bg-orange-100 text-orange-800 px-2 py-1 rounded-md text-xs font-semibold';
                default: return 'bg-gray-100 text-gray-800 px-2 py-1 rounded-md text-xs font-semibold';
            }
        }

        /**
         * Updates the sort icons on table headers to reflect current sort state.
         */
        function updateSortIcons() {
            tableHeaders.forEach(header => {
                const sortKey = header.dataset.sortKey;
                const iconSpan = header.querySelector('.sort-icon');
                if (iconSpan) {
                    iconSpan.innerHTML = '';
                    const icon = document.createElement('i');
                    if (sortKey === currentSortColumn) {
                        icon.classList.add('fas');
                        if (currentSortOrder === 'asc') {
                            icon.classList.add('fa-sort-up');
                        } else {
                            icon.classList.add('fa-sort-down');
                        }
                    } else {
                        icon.classList.add('fas', 'fa-sort');
                    }
                    iconSpan.appendChild(icon);
                }
            });
        }

        /**
         * Attaches event listeners to edit and delete buttons in the table.
         */
        function addJobTableEventListeners() {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.onclick = (e) => openJobModalForEdit(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => showCustomConfirm("确定要删除这条岗位记录吗？", () => confirmDeleteJob(e.currentTarget.dataset.id));
            });
        }

        /**
         * Renders the D3.js chart based on the selected period (weekly bar or monthly line).
         */
        function renderSubmissionsChart() {
            const chartContainer = document.getElementById('submissions-chart-container');
            const width = chartContainer.clientWidth;
            const height = chartContainer.clientHeight;
            const margin = { top: 20, right: 30, bottom: 40, left: 40 };

            submissionsChartSvg.selectAll("*").remove(); // Clear previous chart

            if (width === 0 || height === 0) { // If container is not visible or has no size
                console.warn("Chart container has zero width or height. Chart might not render correctly.");
                noChartDataMessage.classList.remove('hidden'); // Show message if chart can't render
                return;
            } else {
                noChartDataMessage.classList.add('hidden');
            }


            const svg = submissionsChartSvg
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            let data = [];
            let chartType = ''; // 'bar' or 'line'

            if (currentChartPeriod === 'weekly') {
                chartType = 'bar';
                let chartDataMap = {};
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);
                    const dateStr = formatDate(d);
                    chartDataMap[dateStr] = 0;
                }

                jobRecords.forEach(job => {
                    const jobDate = new Date(job.time);
                    const key = formatDate(jobDate);
                    if (chartDataMap.hasOwnProperty(key)) {
                        chartDataMap[key]++;
                    }
                });
                data = Object.keys(chartDataMap).map(key => ({
                    label: key,
                    count: chartDataMap[key]
                })).sort((a, b) => a.label.localeCompare(b.label));

            } else { // monthly
                chartType = 'line';
                let chartDataMap = {};
                const daysInMonth = new Date(parseInt(selectedYear), parseInt(selectedMonth), 0).getDate();

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayStr = i.toString().padStart(2, '0');
                    const dateKey = `${selectedYear}-${selectedMonth}-${dayStr}`;
                    chartDataMap[dateKey] = 0;
                }

                jobRecords.forEach(record => {
                    const recordDate = new Date(record.time);
                    const recordYear = recordDate.getFullYear().toString();
                    const recordMonth = (recordDate.getMonth() + 1).toString().padStart(2, '0');
                    const recordDay = recordDate.getDate().toString().padStart(2, '0');

                    if (recordYear === selectedYear && recordMonth === selectedMonth) {
                        const dateKey = `${recordYear}-${recordMonth}-${recordDay}`;
                        if (chartDataMap.hasOwnProperty(dateKey)) {
                            chartDataMap[dateKey]++;
                        }
                    }
                });
                data = Object.keys(chartDataMap).map(key => ({
                    label: key.slice(8), // Just the day part (e.g., "01", "15")
                    count: chartDataMap[key]
                })).sort((a, b) => parseInt(a.label) - parseInt(b.label));

                // Show/hide monthly selectors
                monthlySelectorsDiv.classList.remove('hidden');
                // Check if no data for the selected month
                if (data.every(d => d.count === 0)) {
                    noChartDataMessage.classList.remove('hidden');
                } else {
                    noChartDataMessage.classList.add('hidden');
                }


            }
            // Hide monthly selectors if not in monthly view
            if (currentChartPeriod !== 'monthly') {
                monthlySelectorsDiv.classList.add('hidden');
                noChartDataMessage.classList.add('hidden'); // Also hide the no data message for weekly view
            }

            // X axis
            const x = d3.scaleBand()
                .range([0, innerWidth])
                .domain(data.map(d => d.label))
                .padding(0.2);

            svg.append("g")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            // Y axis
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.count) + 1 || 5]) // Ensure Y-axis goes up to at least 5
                .range([innerHeight, 0]);

            svg.append("g")
                .call(d3.axisLeft(y).ticks(Math.min(d3.max(data, d => d.count) || 5, 5)));

            // Draw chart based on type
            if (chartType === 'bar') {
                svg.selectAll("rect")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("x", d => x(d.label))
                    .attr("y", d => y(d.count))
                    .attr("width", x.bandwidth())
                    .attr("height", d => innerHeight - y(d.count))
                    .attr("fill", "#60a5fa"); // Tailwind blue-400
            } else if (chartType === 'line') {
                const line = d3.line()
                    .x(d => x(d.label) + x.bandwidth() / 2) // Center points in band
                    .y(d => y(d.count));

                svg.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "#8884d8") // Purple color
                    .attr("stroke-width", 3)
                    .attr("d", line);

                // Add circles for data points
                svg.selectAll("dot")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx", d => x(d.label) + x.bandwidth() / 2)
                    .attr("cy", d => y(d.count))
                    .attr("r", 5)
                    .attr("fill", "#8884d8")
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2);
            }
        }

        /**
         * Populates the year and month dropdowns for the monthly chart view.
         */
        function populateYearMonthSelectors() {
            const currentYear = new Date().getFullYear();
            // Clear existing options
            yearSelect.innerHTML = '';
            monthSelect.innerHTML = '';

            // Populate years (e.g., current year - 5 to current year + 1)
            for (let i = currentYear - 5; i <= currentYear + 1; i++) {
                const option = document.createElement('option');
                option.value = i.toString();
                option.textContent = `${i} 年`;
                yearSelect.appendChild(option);
            }
            yearSelect.value = currentYear.toString(); // Default to current year

            // Populate months
            for (let i = 1; i <= 12; i++) {
                const monthStr = i.toString().padStart(2, '0');
                const option = document.createElement('option');
                option.value = monthStr;
                option.textContent = `${i} 月`;
                monthSelect.appendChild(option);
            }
            monthSelect.value = (new Date().getMonth() + 1).toString().padStart(2, '0'); // Default to current month

            // Add event listeners for changes
            yearSelect.addEventListener('change', renderSubmissionsChart);
            monthSelect.addEventListener('change', renderSubmissionsChart);
        }

        // --- Event Handlers ---

        // Mobile menu toggle
        menuToggle.addEventListener('click', () => {
            mainNav.classList.toggle('hidden');
        });

        // Parse job link or text
        parseJobBtn.addEventListener('click', () => {
            const input = parseJobInput.value.trim();
            if (!input) {
                showCustomAlert('请输入岗位链接或文字！');
                return;
            }

            let company = '';
            let position = '';
            let notes = '';
            let industry = '';
            let keywords = '';
            let location = '';

            if (input.startsWith('http://') || input.startsWith('https://')) {
                try {
                    const url = new URL(input);
                    company = url.hostname.split('.')[1] || url.hostname;
                    position = url.pathname.split('/').pop() || '';
                    if (position.includes('/') && position.length > 20) position = ''; // If path is too complex/long, clear it
                    notes = `来自链接: ${input}`;
                } catch (e) {
                    showCustomAlert('无效的链接格式，请手动填写。');
                    notes = `原始输入: ${input}`;
                }
            } else {
                // Attempt to parse from text: Company, Position, Keywords, Industry, Location, Notes
                const parts = input.split(/[,，\s]+/);
                if (parts.length > 0) {
                    company = parts[0] || '';
                    position = parts[1] || '';
                    keywords = parts[2] || '';
                    industry = parts[3] || '';
                    location = parts[4] || '';
                    notes = parts.slice(5).join(', ') || input;
                } else {
                    position = input; // If only one part, assume it's the position
                }
            }

            // Pre-fill modal and open it
            modalTitle.textContent = '添加新岗位 (解析)';
            modalTimeInput.value = formatDate(new Date());
            modalCompanyInput.value = company;
            modalPositionInput.value = position;
            modalKeywordsInput.value = keywords;
            modalIndustryInput.value = industry;
            modalStatusSelect.value = '投递'; // Default status
            modalLocationInput.value = location;
            modalNotesInput.value = notes;
            modalLevelSelect.value = '中'; // Default level
            currentEditingJobId = null; // Ensure it's in add mode

            jobModal.classList.remove('hidden');
        });

        // Toggle chart period (Weekly/Monthly)
        toggleWeeklyBtn.addEventListener('click', () => {
            currentChartPeriod = 'weekly';
            toggleWeeklyBtn.classList.add('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
            toggleMonthlyBtn.classList.remove('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
            toggleMonthlyBtn.classList.add('text-gray-600', 'hover:bg-gray-100');
            renderSubmissionsChart();
        });

        toggleMonthlyBtn.addEventListener('click', () => {
            currentChartPeriod = 'monthly';
            toggleMonthlyBtn.classList.add('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
            toggleWeeklyBtn.classList.remove('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
            toggleWeeklyBtn.classList.add('text-gray-600', 'hover:bg-gray-100');
            renderSubmissionsChart();
        });

        // Show add new job modal
        addNewJobBtn.addEventListener('click', () => {
            modalTitle.textContent = '添加新岗位';
            jobForm.reset(); // Clear form fields
            modalTimeInput.value = formatDate(new Date()); // Default to current date
            modalStatusSelect.value = '投递'; // Ensure default status is '投递'
            modalLevelSelect.value = '中'; // Ensure default level is '中'
            currentEditingJobId = null; // Clear editing state
            jobModal.classList.remove('hidden');
        });

        // Hide modal
        cancelModalBtn.addEventListener('click', () => {
            jobModal.classList.add('hidden');
        });

        // Submit form (add/edit)
        jobForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const newJob = {
                id: currentEditingJobId || Date.now(), // Use existing ID for edit, new timestamp for add
                time: new Date(modalTimeInput.value),
                company: modalCompanyInput.value.trim(),
                position: modalPositionInput.value.trim(),
                keywords: modalKeywordsInput.value.trim(),
                industry: modalIndustryInput.value.trim(),
                status: modalStatusSelect.value,
                location: modalLocationInput.value.trim(),
                notes: modalNotesInput.value.trim(),
                level: modalLevelSelect.value,
            };

            // Simple form validation
            if (!newJob.company || !newJob.position) {
                showCustomAlert("公司和岗位名称不能为空！");
                return;
            }

            if (currentEditingJobId) {
                // Edit existing job
                const index = jobRecords.findIndex(job => job.id === currentEditingJobId);
                if (index !== -1) {
                    jobRecords[index] = newJob;
                }
            } else {
                // Add new job
                jobRecords.push(newJob);
            }

            saveJobRecords();
            updateOverviewStats();
            renderJobTable();
            renderSubmissionsChart();
            jobModal.classList.add('hidden'); // Close modal
        });

        /**
         * Opens the job modal for editing an existing record.
         * @param {string} id The ID of the job record to edit.
         */
        function openJobModalForEdit(id) {
            const job = jobRecords.find(j => j.id == id);
            if (job) {
                modalTitle.textContent = '编辑岗位';
                currentEditingJobId = job.id;
                modalTimeInput.value = formatDate(job.time);
                modalCompanyInput.value = job.company;
                modalPositionInput.value = job.position;
                modalKeywordsInput.value = job.keywords;
                modalIndustryInput.value = job.industry;
                modalStatusSelect.value = job.status;
                modalLocationInput.value = job.location;
                modalNotesInput.value = job.notes;
                modalLevelSelect.value = job.level;
                jobModal.classList.remove('hidden');
            }
        }

        /**
         * Confirms and deletes a job record.
         * @param {string} id The ID of the job record to delete.
         */
        function confirmDeleteJob(id) {
            jobRecords = jobRecords.filter(job => job.id != id);
            saveJobRecords();
            updateOverviewStats();
            renderJobTable();
            renderSubmissionsChart();
        }

        // --- Filter and Sort Event Listeners ---
        globalSearchInput.addEventListener('input', renderJobTable);
        filterStatusSelect.addEventListener('change', renderJobTable);
        filterStartDateInput.addEventListener('change', renderJobTable);
        filterEndDateInput.addEventListener('change', renderJobTable);

        // Table header click for sorting
        tableHeaders.forEach(header => {
            header.addEventListener('click', (e) => {
                const sortKey = e.currentTarget.dataset.sortKey;
                if (!sortKey) return;

                if (currentSortColumn === sortKey) {
                    currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = sortKey;
                    currentSortOrder = 'asc'; // Default to ascending when changing column
                }
                renderJobTable();
            });
        });

        resetFiltersBtn.addEventListener('click', () => {
            globalSearchInput.value = '';
            filterStatusSelect.value = '';
            const today = new Date().toISOString().slice(0, 10);
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            filterStartDateInput.value = formatDate(oneMonthAgo);
            filterEndDateInput.value = today;

            currentSortColumn = 'time';
            currentSortOrder = 'desc';
            renderJobTable();
        });

        // Click interview/offer count boxes to filter table
        document.getElementById('interview-count-box').addEventListener('click', () => {
            filterStatusSelect.value = '一面'; // Filter to a representative interview status
            renderJobTable();
        });
        document.getElementById('offer-count-box').addEventListener('click', () => {
            filterStatusSelect.value = 'OC';
            renderJobTable();
        });

        // --- Custom Dialog Logic (replacing native alert/confirm) ---
        function showCustomAlert(message) {
            const alertModal = document.createElement('div');
            alertModal.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-black', 'bg-opacity-50', 'z-[9999]');
            alertModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4 text-center">
                    <p class="text-lg font-medium text-gray-800 mb-6">${message}</p>
                    <button id="alert-ok-btn" class="bg-blue-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                        确定
                    </button>
                </div>
            `;
            document.body.appendChild(alertModal);
            document.getElementById('alert-ok-btn').onclick = () => alertModal.remove();
        }

        function showCustomConfirm(message, onConfirm) {
            const confirmModal = document.createElement('div');
            confirmModal.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-black', 'bg-opacity-50', 'z-[9999]');
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4 text-center">
                    <p class="text-lg font-medium text-gray-800 mb-6">${message}</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-700 py-2 px-6 rounded-lg font-semibold hover:bg-gray-300 transition duration-200">
                            取消
                        </button>
                        <button id="confirm-ok-btn" class="bg-red-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-red-700 transition duration-200">
                            确定
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            document.getElementById('confirm-ok-btn').onclick = () => {
                onConfirm();
                confirmModal.remove();
            };
            document.getElementById('confirm-cancel-btn').onclick = () => confirmModal.remove();
        }

    </script>
</body>

</html>